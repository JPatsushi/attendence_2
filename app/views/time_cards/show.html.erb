<% provide(:title, @user.name) %>

<!--<@%= render 'static_pages/user_logged_in' %>-->

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </br>
        
        <%= form_for monthly_authentications_path do |pf| %>
        
        <% (2..User.all.count - 1).each do |id| %>
          <% array = [] %>
          <% @authentication_events.each {|event| array << event if event.user_id == id} %>
          <% if array != [] %>
          <h4 style="text-align: center;">【<%= array.first.user.name %>からの一ヶ月分勤怠申請】</h4>
          <table class="table table-bordered table-striped">
           <thead>
             <tr>
               <th>年</th>
               <th>月</th>
               <th>指示者確認</th>
               <th>変更</th>
               <th>勤怠を確認する</th>
             </tr>
           </thead>
           <tbody>
            <% array.each do |obj| %>
             <%= fields_for "list[#{id}][#{obj.year}_#{obj.month}]", obj do |f| %>  
             <tr>
               <td><%= obj.year %></td>
               <td><%= obj.month %></td>
               <td class="modal_option"><%= f.select :status, options_for_select([["なし",1],["申請中",2],["承認",3],["否認",4]]) %></td>
               <td><%= check_box_tag("#{id}_#{obj.year}_#{obj.month}_confirm") %></td>
               <td><%= link_to button_tag("osu", type: 'button', class: "btn btn-primary"), time_card_path(obj.user, year: obj.year, month: obj.month), :target => "_blank", rel: "noreferrer" %></td>
             </tr>
             <% end %>
            <% end %> 
           </tbody>
          </table>
          <% end %>
        <% end %>
        <%= pf.submit "変更を送信する", class: "btn btn-primary" %>
        <% end %>
       
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

 <script>
  $(function(){
    var modal = document.getElementById('myModal');
    $("#monthly").click(function(){
        $("header").css("padding-right", 17);
    })
    $(".modal-header span").click(function() {
        $("header").css("padding-right", 0);
    })    
    $(window).click(function(event) {
        if (event.target == modal) {
        // $("header").css("background-color", "blue");
        $("header").css("padding-right", 0);
        }
    })
  })
 </script>

<script>
$(function() {
  
  var day = $('#day').text();
  $("#timecard-form").css("top", 365 + (day - 1) * 37);
  // var test = $('#hoge').data('water-id');
  // document.write(test);
 
})

</script> 

<table class="table table-bordered">
    <thead>
        <tr>
            <th rowspan="2" style="vertical-align: middle;">
              <% if current_user == @user %>
                <%= link_to subtract_time_card_path, method: :patch, remote: true do %>
                  <button class= "btn btn-primary">←</button>
                <% end %>
              <% end %>
              <span>　　</span>
              <%= @year %>年<%= @month %>月 時間管理表
              <span>　　</span>
              <% if current_user == @user %>
                <%= link_to add_time_card_path, method: :patch, remote: true do %>
                  <button class= "btn btn-primary">→</button>
                <% end %>
              <% end %>
            </th>
              <th rowspan="2">指定勤務時間 <% if @time_info %><%= time_string_10digits(@time_info.must_work_time) %><% end %></br>
              指定勤務終了時間</th>
            <th rowspan="2" colspan="3"></br>基本時間 <% if @time_info %><%= time_string_10digits(@time_info.sd_work_time) %><% end %></th>
            <th rowspan="2">初日 <%= @first_day.month %>/<%= @first_day.day %></th>
        </tr>
        <tr>
        </tr>
        <tr>
            <th>所属 <%= @user.depart %></th>
            <th>氏名 <%= @user.name %></th>
            <th>コード</th><th>5555</th>
            <th>出勤日数 <%= @time_cards_count %>日</th>
            <th>締め <%= @last_day.month %>/<%= @last_day.day %></th>
        </tr>
    </thead>
</table>

<!--<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">-->
<!--  【所属長承認申請のお知らせ】-->
<!--</button>-->
<% if current_user == @user %>
  <% if @user.superior && @authentication_events.count != 0 %>
    <div>
      <button id="monthly" style="color:red;" data-toggle="modal" data-target="#myModal">
         【所属長承認申請のお知らせ】
      </button>
      <span style="color:red; border: 3px solid red;"><%= @authentication_events.count %>件の通知があります</span>
      <p>【勤怠変更申請のお知らせ】</p>
      <p>【残業申請のお知らせ】</p>
    </div>
  <% elsif current_user.superior %>
    <div> 
      <p>【所属長承認申請のお知らせ】</p>
      <p>【勤怠変更申請のお知らせ】</p>
      <p>【残業申請のお知らせ】</p>
    </div>
  <% else %>
  <% end %>
<% end %>

<% if current_user == @user %>
  <div>
    <%= link_to edit_time_card_path do %>
      <button class= "btn btn-primary btn-lg">勤怠を編集</button>
    <% end %>
    <%= link_to time_card_path(format: :csv) do %>
      <button class= "btn btn-primary btn-lg">CSV出力</button>
    <% end %>
    </br>
    <%= link_to edit_time_card_path do %>
      <button class= "btn btn-primary btn-lg">勤怠修正ログ（承認済）</button>
    <% end %>
  </div>
  </br>
  </br>
<% end %>

<table class="table table-bordered table-striped">
  <thead>
    <tr>
      <th rowspan="3">残業申請</th>
      <th rowspan="3">日付</th
      ><th rowspan="3">曜日</th>
      <th colspan="8">【実績】</th
      ><th colspan="5">所定外勤務</th>
    </tr>
    <tr>
      <th colspan="3">出社</th>
      <th colspan="3">退社</th>
      <th rowspan="2">在社時間</th>
      <th rowspan="2">備考</th>
      <th colspan="2">終了予定時間</th>
      <th rowspan="2">時間外時間</th>
      <th rowspan="2">業務処理内容</th>
      <th rowspan="2">支持者確認</th>
    </tr>
    <tr>
      <th>時</th>
      <th>分</th>
      <th style="width:6%"></th>
      <th>時</th>
      <th>分</th>
      <th style="width:6%"></th>
      <th>時</th>
      <th>分</th>
    </tr>
  </thead>
  <tbody>
    <% each_date_in_month(@year, @month) do |date, index| %>
    <tr>
      <td><% if current_user == @user %>
           <%= link_to edit_time_card_path do %>
             <button class= "btn btn-primary over_work">残業申請</button>
           <% end %>
         <% end %>
      </td>
      <td><%= date_in_japanese(date, :month_day) %></td>
      <td><%= day_of_the_week_in_japanese(date, :short) %></td>
    <% if @time_cards[index] %>
      <td><%= time_string_hour(@time_cards[index].in_at) %></td>
      <td><%= time_string_min(@time_cards[index].in_at) %></td>
      <td></td>
      <td><%= time_string_hour(@time_cards[index].out_at) %></td>
      <td><%= time_string_min(@time_cards[index].out_at) %></td>
      <td></td>
      <td><%= work_hours(@time_cards[index].work_hours) %></td>
      <td><%= @time_cards[index].remark%></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    <% else %>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    <% end %>
    </tr> 
    <% end %>
    <tr>
      <% if @time_info %>
        <td style="vertical-align:top;"><%= total_standard_work_time(@time_info.sd_work_time,@time_cards_count) %></td>
      <% else %>
        <td style="vertical-align:top;"><%= 0 %></td>
      <% end %>
      <td colspan="2"></td>
      <td colspan="6"></td>
      <% total_time = total_work_time(@user_time_cards) %>
      <td style="vertical-align:top;"><%= work_hours_10digits(total_time) %></td>
      <td colspan="5"></td>
      
      
      <td>
        <%= form_for @monthly_authentication, url: monthly_authentication_path do |f| %>
        <%= f.label :status,"所属長承認　#{@monthly_authentication.status}" %>
        <% if current_user == @user %>
          <%= select_tag(:superior_man, options_for_select(@superiors_list), class: 'form-control')  %>
          <%= f.submit "申請", class: "btn btn-primary" %>
          <% end %>
        <% end %>
      </td>
    </tr>
  </tbody>
</table>
<% if current_user == @user %>
  <%= form_tag(updata_time_card_path, remote: true, method: :patch, id: 'timecard-form', class: 'form-group show_button') do |f| %>
    <% if @time_card.month == @month && @time_card.year == @year %>
      <% if !@time_card.in_at %>
        <%= submit_tag('出社', name: 'in', id: 'in', disabled: !!@time_card.in_at, class: 'btn btn-primary show_button1') %>
      <% elsif !@time_card.out_at %>
        <%= submit_tag('退社', name: 'out', id: 'out', disabled: !@time_card.in_at || !!@time_card.out_at, class: 'btn btn-success show_button2') %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<div class="hidden">
  <span id="day"><%= @time_card.day %></span>
</div>

<!--<div id="hoge" class="hidden" data-water-id="<#%= @time_card.day %>"></div>-->






